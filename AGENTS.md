# AGENTS.md (DramaEngine)

## 目的（このリポジトリで Codex にやらせること）
- 機械的リファクタ（命名変更、ファイル分割、include整理、重複排除）
- ドキュメント更新（設計メモ、API説明、規約の追記）
- コードレビュー/設計レビュー（危険箇所の指摘、改善案の提示）
- バグ修正（ただし “根拠なく推測で直す” のは禁止。必ず再現・ログ・原因→修正）

## 言語
- すべて日本語で回答・コメント。
- 例外：HLSL の識別子や外部API名は英語のまま。

## ビルド（必須）
- ビルド方式：MSBuild で `DramaEngine.slnx`
- 指定：`Debug|x64`
- NuGet は使わない（restore もしない）
- 変更を入れたら、原則として **`scripts/codex_build.ps1` を実行して通す**。
  - 実行コマンド: `pwsh -NoProfile -File scripts/codex_build.ps1`

## A/B/C（MCP 3種の役割分担）
A) **Serena**: “コードベース検索/参照” 専用（どのファイルを触るべきか、依存関係、参照箇所の列挙）
B) **Sequential Thinking**: “設計検討の思考手順” 専用（アーキ案の比較、トレードオフ、決定基準の明確化）
C) **Memory Bank**: “決定事項の固定化” 専用（決めたことを後で蒸し返さないための要点保存）

運用ルール（重要）:
- **デフォルトは Serena だけ**使う（＝普段のコーディング支援）。
- 設計検討が必要なときだけ Sequential Thinking を使う。
- 結論が出たら Memory Bank に「決定事項・理由・影響範囲」を保存してから実装に入る。
- MCP を乱用して “ツールを回してるだけ” になったら即中止して、通常の調査＋提案に戻る。

## コーディング規約（このファイルが正）
### 1) フォーマット
- clang-format 使用
- Allman（波括弧は改行）

### 2) 命名（厳守）
- 型: PascalCase（例: `LinearArena`, `FixedBlockPool`）
- 関数: snake_case（例: `create`, `output_debug_string`）
- 変数: camelCase
- メンバ: `m_` プレフィックス（例: `m_nodes`）
- `using namespace` 禁止
- 頭字語は最初のみ大文字（例: `Http`, `Xml`）

### 3) 制御構文
- if/for/while/switch など **必ず `{}` を付ける**（単行でも例外なし）

### 4) 例外・エラー処理
- 例外禁止
- 失敗は戻り値（Result / ErrorCode 等）で返す
- `assert` は “不変条件の破綻” のみに限定

### 5) 所有権
- 所有: `std::unique_ptr` 優先
- 共有所有が必要な場合のみ `std::shared_ptr`
- 生ポインタは **非所有参照のみ**
- DLL境界など共有は “寿命の責任者” を明確化する

### 6) 関数内コメント（必須）
- 関数内の処理フローは `// 1) ...` `// 2) ...` の番号付きで書く
- “何をしているか” ではなく “なぜそうするか” を優先

### 7) 禁止事項
- ヘッダでのマクロ乱用（定数は `constexpr`）
- 暗黙的型変換（意図しない変換防止）
- `new`/`delete` の直書き（スマートポインタ使用）
- グローバル可変変数（状態が壊れる）

### 8) 外部ライブラリ
- 外部ライブラリの中身は書き換え禁止（必要ならラップ側で対応）
- 同ソリューション内ではプロジェクト分離
